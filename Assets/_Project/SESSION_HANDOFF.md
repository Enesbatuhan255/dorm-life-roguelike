# DormLifeRoguelike - Session Handoff

Last updated: 2026-02-18
Project root: `C:\DormLifeRoguelike\My project`

## Quick Update (2026-02-18)
- [x] Tuning Sprint V1 kicked off (cooldown/category/queue focus)
  - Baseline simulation executed via:
    - `DormLifeRoguelike.Tests.EditMode.BalanceSimulationTests.DebtEnforcement_RiskyProfile_ShowsHarsherOutcomesThanCautious`
  - Baseline snapshot (40 runs/profile):
    - Cautious: `HarshDebtRate=0.00`, endings `FailedExtendedYear:40`
    - Balanced: `HarshDebtRate=0.35`, endings `FailedExtendedYear:26`, `ExpelledDebtSpiral:14`
    - Risky: `HarshDebtRate=0.80`, endings `ExpelledDebtSpiral:32`, `FailedExtendedYear:8`
  - Kickoff report added:
    - `Assets/_Project/Reports/TUNING_SPRINT_V1_KICKOFF_2026-02-18.md`
  - Iteration V1-A applied:
    - Added `24h` per-event cooldown overrides for
      - `EVT_MAJOR_DEBT_001`, `EVT_MAJOR_DEBT_002`, `EVT_MAJOR_GAMBLE_002`, `EVT_MAJOR_GAMBLE_003`
    - Reduced weights:
      - Debt: `1.20->1.10`, `1.25->1.15`
      - Gamble: `0.85->0.80`, `0.80->0.75`
    - Balance simulation test still passed with same baseline distribution.
    - Next step: tune high-impact follow-up/choice branches (not only weighted pool cadence).
  - Iteration V1-B applied (branch-level severity softening):
    - Debt/Gamble critical choices softened and delayed follow-ups increased:
      - `EVT_MAJOR_DEBT_001`, `EVT_MAJOR_DEBT_002`, `EVT_MAJOR_GAMBLE_002`, `EVT_MAJOR_GAMBLE_003`
    - Gameplay gates after tuning:
      - EditMode (`DormLifeRoguelike.Tests`): Passed 77/77
      - PlayMode (`DormLifeRoguelike.Tests`): Passed 4/4
    - BalanceSimulation summary stayed numerically unchanged.
    - Next action: enrich simulation choice policy so branch-level content tuning is reflected in metrics.
  - Iteration V1-C applied (simulation choice policy enrichment):
    - `BalanceSimulationTests.SelectChoice` now includes event-specific debt/gamble branch heuristics + profile-weighted fallback scoring.
    - Gameplay test suite remains passing.
    - Baseline balance summary still unchanged; next lever should be simulation profile thresholds/day-plan behavior.
- [x] Operational path-risk mitigation package prepared (no-space migration)
  - Added migration script:
    - `Tools/mcp/migrate_project_path_no_spaces.ps1`
  - Added runbook:
    - `Assets/_Project/Reports/PROJECT_PATH_MIGRATION_RUNBOOK.md`
  - Dry-run validated successfully from current workspace.
  - Note: project folder move is not executed yet in this session.
- [x] Stat HUD polish pass completed in code
  - `Assets/_Project/Scripts/UI/StatHudPresenter.cs`
  - Added risk-aware, color-coded stat rendering:
    - Hunger / Mental / Energy: `OK/LOW/CRITICAL`
    - Money: `SAFE/TIGHT/DEBT/DEBT+`
    - Academic: `GOOD/MID/RISK`
    - Sleep Debt: `LOW/MID/HIGH`
  - Added consistent numeric formatting and optional rich-text rendering toggle (`useRichText`).
  - Validation:
    - `DormLifeRoguelike.Tests.EditMode`: Passed 77/77
    - `DormLifeRoguelike.Tests.PlayMode`: Passed 4/4
- [x] Large UI presenter refactor pass (behavior-preserving)
  - `ActionPanelPresenter` split into:
    - `Assets/_Project/Scripts/UI/ActionPanelPresenter.cs`
    - `Assets/_Project/Scripts/UI/ActionPanelPresenter.Ui.cs`
    - `Assets/_Project/Scripts/UI/ActionPanelPresenter.Interactive.cs`
  - `MicroChallengePanelPresenter` split into:
    - `Assets/_Project/Scripts/UI/MicroChallengePanelPresenter.cs`
    - `Assets/_Project/Scripts/UI/MicroChallengePanelPresenter.Ui.cs`
  - No behavior change intended; only structure/maintainability improvement.
  - Validation:
    - `DormLifeRoguelike.Tests.EditMode`: Passed 77/77
    - `DormLifeRoguelike.Tests.PlayMode`: Passed 4/4
- [x] Save/Load runtime scope expanded (schema v2)
  - `GameSnapshot` now persists:
    - `EventManager` runtime state (current + pending event IDs)
    - `EventScheduler` runtime state (cooldowns, queued-day markers, delayed follow-ups, repeat buffer)
    - `GameOutcomeSystem` runtime state (resolved result + internal counters)
  - `SnapshotMigrator.CurrentSchemaVersion` upgraded to `2` with backward-compatible default migration.
  - `SaveLoadService` restore order updated to:
    - time/stats/flags
    - scheduler state
    - event manager queue/current event
    - outcome state
- [x] Save/Load regression coverage expanded
  - `SaveLoadServiceTests.SaveAndLoad_Roundtrip_RestoresSchedulerQueueAndOutcomeState`
  - Validated delayed follow-up continues after load and resolved outcome state is preserved.
- [x] PlayMode scheduler coverage expanded
  - Added `Assets/_Project/Tests/PlayMode/EventSchedulerPlayModeCoverageTests.cs`
  - New PlayMode cases:
    - delayed choice follow-up enqueue timing
    - same follow-up chain repeat processing for multiple roots
    - context tag gating (`ExamWindow + MoneyLow`)
  - Validation:
    - `DormLifeRoguelike.Tests.PlayMode`: Passed 4/4
    - `DormLifeRoguelike.Tests.EditMode`: Passed 76/76
- [x] Stabilization baseline lock refreshed (gameplay scope)
  - EditMode gate (`DormLifeRoguelike.Tests.EditMode`): Passed 76/76
  - PlayMode gate (`DormLifeRoguelike.Tests.PlayMode`): Passed 1/1
- [x] Gameplay acceptance gate clarified
  - Official gameplay gate is namespace-scoped (`DormLifeRoguelike.Tests.*`)
  - Full editor-wide failures in `com.IvanMurzak...` remain out-of-scope for gameplay acceptance
- [x] Production EventData context/weight tuning pass applied
  - Updated major events:
    - `EVT_MAJOR_DEBT_001` weight -> `1.20`
    - `EVT_MAJOR_DEBT_002` weight -> `1.25`
    - `EVT_MAJOR_GAMBLE_002` weight -> `0.85`
    - `EVT_MAJOR_GAMBLE_003` weight -> `0.80`
  - Updated minor events:
    - `EVT_MINOR_COST_002`: tags -> `ExamWindow + MoneyLow`, weight -> `0.95`
    - `EVT_MINOR_COST_004`: tags -> `ExamWindow + MoneyLow`, weight -> `0.95`
    - `EVT_MINOR_HEALTH_001`: tags -> `NotExamWindow + EnergyLow`, weight -> `0.90`
    - `EVT_MINOR_SOC_001`: tags -> `MentalLow + NotExamWindow`, weight -> `0.90`
    - `EVT_MINOR_TRANS_001`: tags -> `NotInflationDay + MoneyLow`, weight -> `0.95`
    - `EVT_MINOR_STUDY_001`: weight -> `1.15`
- [x] Event content reports regenerated
  - `Assets/_Project/Reports/event_choice_coverage_report.csv`
  - `Assets/_Project/Reports/event_chain_graph.csv`

## Quick Update (2026-02-17)
- [x] Event choice metadata model expanded
  - `EventChoice.notes` and `EventChoice.flags` fields added
  - New flag payload type: `EventFlagChange` (`AddNumeric`, `SetText`)
- [x] Runtime flag systems integrated
  - `FlagStateService` stores numeric/text flags from applied choices
  - `FlagRuleService` applies daily stat effects from key flags (`debt_pressure`, `work_strain`, `burnout`, `kyk_risk_days`, `illegal_fine_pending`)
  - `GameBootstrap` now registers `IFlagStateService` and `IFlagRuleService`
- [x] Flag regression coverage
  - `EventFlagStateTests` verifies choice flags are applied
  - `FlagRuleServiceTests` verifies daily flag effects + counter decay
- [x] Wave 2 choice-depth rollout completed (remaining 12 production events)
  - Full production policy is now satisfied:
    - Major>=3 choices: 16/16
    - Minor>=2 choices: 12/12
  - `event_choice_coverage_report.csv` now has 0 violations
- [x] Wave 1 event choice-depth rollout completed (16 high-impact events)
  - Major targets upgraded to >=3 choices, Minor targets upgraded to >=2 choices
  - Updated IDs include Debt/KYK/Gamble core chain + selected crisis/minor events
- [x] Content pipeline tooling added
  - `EventChoiceCoverageValidator` (menu + CSV export)
  - `EventChainGraphReport` (menu + CSV export)
  - Reports generated:
    - `Assets/_Project/Reports/event_choice_coverage_report.csv`
    - `Assets/_Project/Reports/event_chain_graph.csv`
- [x] New editor regression tests added
  - `EventChoicePolicyTests` (Wave 1 policy gate)
  - `EventChainIntegrityTests` (follow-up target existence)
- [x] Current policy coverage snapshot
  - Global Major>=3: 16/16
  - Global Minor>=2: 12/12
  - Remaining policy gaps: 0
- [x] Event chain/follow-up repeat behavior completed in `EventScheduler`
  - Same follow-up ID is now processed for each trigger (immediate and delayed paths)
  - Repeated follow-ups that cannot enqueue immediately are buffered and drained after event completions/day change
- [x] `IEventManager.EnqueueEvent` now returns `bool` success status
- [x] Added chain repeat regression coverage in `EventSchedulerPolicyTests`
  - `MultipleSources_SameImmediateFollowUp_ProcessesEachTrigger`
  - `MultipleSources_SameDelayedFollowUp_ProcessesEachTrigger`
- [x] Event category/context filter logic hardened in `EventScheduler`
  - Stat-dependent tags now fail-closed when scheduler has no injected `IStatSystem`
  - Time/calendar tags remain evaluable without `IStatSystem`
- [x] Added policy regression coverage in `EventSchedulerPolicyTests`
  - `MinorSelection_StatTaggedEvent_IsNotEligible_WhenSchedulerHasNoStatSystem`
  - `MinorSelection_TimeTaggedEvent_WorksWithoutStatSystem`
- [x] Validation snapshot after changes
  - `DormLifeRoguelike.Tests.EditMode`: Passed 68/68
- [x] Regression stabilization executed for `_Project` scope
  - EditMode run #1 (`DormLifeRoguelike.Tests.EditMode`): Passed 61/61
  - EditMode run #2 (`DormLifeRoguelike.Tests.EditMode`): Passed 61/61
  - PlayMode smoke (`DormLifeRoguelike.Tests.PlayMode`): Passed 1/1
- [x] Full EditMode reference run still reports 3 unrelated package/installer failures
  - `com.IvanMurzak.Unity.MCP.Editor.Tests.TestToolGameObject.ModifyJson_SolarSystem_PlanetsArray`
  - `com.IvanMurzak.Unity.MCP.Editor.Tests.TokenCounterTests.FormatTokenCount_1000OrMore_ReturnsKFormat`
  - `com.IvanMurzak.Unity.MCP.Installer.Tests.ManifestInstallerTests.All`
  - These are outside `_Project` gameplay scope and remain excluded from gameplay gate.
- [x] Stability gate status: met (2 consecutive clean `_Project` EditMode runs)

## Quick Update (2026-02-16 Evening)
- [x] MCP <-> Unity connectivity re-verified via `editor-application-get-state`
- [x] Play mode toggle sanity check done (enter/exit play succeeded)
- [x] UI scene wiring re-audited in `Assets/Scenes/SampleScene.unity`
  - `EventCanvas` present with `EventPanel` + `StatHud`
  - `EventSystem` present with `InputSystemUIInputModule`
  - `EventPanelPresenter` references are wired (panel root, title/description/outcome, 3 choice buttons + labels)
  - `StatHudPresenter`, `ActionPanelPresenter`, `TransactionFeedPresenter`, `DayChangePopupPresenter` present on `StatHud` / `EventCanvas`
- [x] Bootstrap assignments re-checked in scene:
  - `scheduledEvents` contains 3 event assets (`Evt_StudyPush`, `Evt_SleepDebt`, `Evt_PartTimeShift`)
  - `EventCooldownConfig`, `SleepDebtConfig`, `GameOutcomeConfig` are assigned
- [x] Runtime behavior expectations confirmed from scripts:
  - `ActionPanelPresenter` / `TransactionFeedPresenter` / `DayChangePopupPresenter` can self-create missing UI references at runtime
  - `GameBootstrap` auto-attaches `GameOutcomePanelPresenter` if missing in scene
- [x] Current blocker/risk note:
  - Unity MCP warns about project path containing spaces (`C:\DormLifeRoguelike\My project`), which may cause intermittent MCP instability
- [x] EditMode regression snapshot:
  - Project gameplay tests (`DormLifeRoguelike.Tests.EditMode`) passed: 16/16
  - Full editor-wide run showed 3 unrelated package/installer test failures (locale/line-ending sensitive), not in `_Project` gameplay code
- [x] Smoke playtest snapshot (manual MCP, SampleScene):
  - PlayMode sanity pass reached game outcome on Day 8 (`title=PASS`, `resolvedOnDay=8`)
  - No new runtime exceptions in last 5 minutes; only known MCP warning about project path spaces

## Completed (Done)
- [x] Core/service setup: `IService`, `ServiceLocator`, `GameBootstrap`
- [x] Stat system: `IStatSystem`, `StatSystem`, `StatType`, `StatChangedEventArgs`
- [x] Time system: `ITimeManager`, `TimeManager`, `TimeChangedEventArgs`
- [x] Event slice: `IEventManager`, `EventManager`, `EventData`, `EventChoice`, `EventCondition`, `StatEffect`, `ConditionOperator`
- [x] Domain reload safe startup/reset in `GameBootstrap`
- [x] Event flow moved to push + queue (`OnEventStarted`, `OnEventCompleted`, `CurrentEvent`, `HasPendingEvents`, `EnqueueEvent`)
- [x] Event UI presenter + bindings (`EventPanelPresenter`)
- [x] Scene UI created and wired in `SampleScene` (`EventCanvas`, `EventPanel`, choice buttons, outcome text)
- [x] Input System compatibility fixes (`EventInputTrigger`, `InputSystemUiBootstrap`, EventSystem input module updates)
- [x] Stat HUD added and wired (`StatHudPresenter` + 5 stat labels)
- [x] Event apply path validated with runtime logs
- [x] Event scheduler service started (`IEventScheduler`, `EventScheduler`)
- [x] Production event pool created and assigned in `GameBootstrap.scheduledEvents`
- [x] Weighted/random event selection added to `EventScheduler`
- [x] `EventScheduler` now evaluates on day change (`ITimeManager.OnDayChanged`)
- [x] Debug time advance input added (`TimeDebugAdvanceInput`, key: `T`)
- [x] `Bootstrap` scene object now hosts: `GameBootstrap`, `EventDebugRunner`, `EventInputTrigger`, `TimeDebugAdvanceInput`
- [x] Action buttons added (`Study`, `Sleep`, `Work`) with stat changes + `ITimeManager.AdvanceTime` integration
- [x] SleepDebt balancing values moved to `SleepDebtConfig` ScriptableObject and assigned to bootstrap
- [x] SleepDebt service completed (night accumulation + sleep suppression + multipliers)
- [x] Economy service completed (daily costs + action transactions)
- [x] Transaction feed added to StatHud (last 5 entries)
- [x] Day-change popup added (`Yeni Gun`, daily-cost summary)
- [x] Queue policy added in `EventManager` (dedupe + max pending size 5)
- [x] Stable event key flow added (`EventData.eventId`, `OnValidate`, duplicate `scheduledEvents` warning)
- [x] Event Audit Editor tool added (`Run Audit`, `Auto-Fix Missing IDs`, `Export CSV`)
- [x] Missing `eventId` values auto-fixed for existing EventData assets (`EVT_MISC_001..004`)
- [x] Event choices now support optional time advancement (`EventChoice.timeAdvanceHours` -> `ITimeManager.AdvanceTime`)
- [x] Mini win/lose condition added (`IGameOutcomeSystem`, `GameOutcomeSystem`, `GameOutcomeResult`)
- [x] Outcome rules moved to `GameOutcomeConfig` (target day, pass/fail thresholds, fail priority)
- [x] Canonical outcome asset created and assigned in scene (`Assets/_Project/ScriptableObjects/Config/GameOutcomeConfig.asset`)
- [x] GameOver/Pass panel added and auto-attached (`GameOutcomePanelPresenter`)
- [x] Player actions now no-op after outcome resolution (`PlayerActionService` guard)
- [x] Regression tests added for outcome flow (`OnGameEnded` single-fire, resolved-after-action no-op)
- [x] MCP PlayMode sanity check script added (`Tools/mcp/playmode_sanity_check.ps1`)
- [x] Scheduler/Queue regression tests expanded (`EventManagerQueuePolicyTests`, `EventSchedulerPolicyTests`)
- [x] Event cooldown balancing moved to config asset (`EventCooldownConfig`: default + per-category + per-event override)
- [x] `EventScheduler` wired to `EventCooldownConfig` (event override > category override > default)
- [x] `GameBootstrap` wired with `eventCooldownConfig` inspector field + runtime fallback warning
- [x] Canonical cooldown asset created and assigned in scene (`Assets/_Project/ScriptableObjects/Config/EventCooldownConfig.asset`)
- [x] `EventData` category field added and exposed for cooldown/category-based logic

## In Progress
- [ ] Tune and polish category/context tagging on production EventData assets

## Next (Planned)
- [ ] Tune cooldown/category/queue policy based on focused playtests
- [ ] Polish UI/UX for Event panel and Stat HUD

## Where To Continue Tomorrow
1. Tune production EventData `requiredContextTags` usage for better category balance in playtests.
2. Add PlayMode coverage for chain repeat behavior and delayed follow-up flows.
3. Tune cooldown/category/queue policy based on focused playtests.
4. Start Save/Load architecture slice (snapshot schema + restore order).

## Important Changed Files
- `Assets/_Project/Scripts/Core/GameBootstrap.cs`
- `Assets/_Project/Scripts/Events/EventChoice.cs`
- `Assets/_Project/Scripts/Systems/IEventManager.cs`
- `Assets/_Project/Scripts/Systems/EventManager.cs`
- `Assets/_Project/Scripts/Systems/IEventScheduler.cs`
- `Assets/_Project/Scripts/Systems/EventScheduler.cs`
- `Assets/_Project/Scripts/UI/EventPanelPresenter.cs`
- `Assets/_Project/Scripts/UI/StatHudPresenter.cs`
- `Assets/_Project/Scripts/UI/ActionPanelPresenter.cs`
- `Assets/_Project/Scripts/UI/TransactionFeedPresenter.cs`
- `Assets/_Project/Scripts/UI/DayChangePopupPresenter.cs`
- `Assets/_Project/Scripts/UI/GameOutcomePanelPresenter.cs`
- `Assets/_Project/Scripts/Utilities/EventDebugRunner.cs`
- `Assets/_Project/Scripts/Utilities/EventInputTrigger.cs`
- `Assets/_Project/Scripts/Utilities/TimeDebugAdvanceInput.cs`
- `Assets/_Project/Scripts/Utilities/InputSystemUiBootstrap.cs`
- `Assets/_Project/Scripts/Editor/EventAuditWindow.cs`
- `Assets/_Project/Reports/event_audit_report.csv`
- `Assets/Scenes/SampleScene.unity`
- `Assets/_Project/Scripts/Systems/IGameOutcomeSystem.cs`
- `Assets/_Project/Scripts/Systems/GameOutcomeResult.cs`
- `Assets/_Project/Scripts/Systems/GameOutcomeSystem.cs`
- `Assets/_Project/Scripts/Systems/GameOutcomeConfig.cs`
- `Assets/_Project/Scripts/Systems/EventCooldownConfig.cs`
- `Assets/_Project/ScriptableObjects/Config/GameOutcomeConfig.asset`
- `Assets/_Project/ScriptableObjects/Config/EventCooldownConfig.asset`
- `Assets/_Project/Tests/Editor/GameOutcomeSystemTests.cs`
- `Assets/_Project/Tests/Editor/EventSchedulerPolicyTests.cs`
- `Assets/_Project/Tests/Editor/EventManagerQueuePolicyTests.cs`
- `Tools/mcp/playmode_sanity_check.ps1`
- `Assets/_Project/PROJECT_TASK_CHECKLIST.md`
